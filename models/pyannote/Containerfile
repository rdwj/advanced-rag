# Pyannote Speaker Diarization Server
# UBI9 base for FIPS compatibility on OpenShift

FROM registry.redhat.io/ubi9/python-311:latest

USER 0

# Install system dependencies for audio processing
RUN dnf install -y \
    libsndfile \
    && dnf clean all

WORKDIR /app

# Copy requirements first for layer caching
COPY --chown=1001:0 requirements.txt .

# Switch to non-root user for pip install
USER 1001

# Install Python dependencies
# Using --extra-index-url for PyTorch with CUDA support
RUN pip install --no-cache-dir \
    --extra-index-url https://download.pytorch.org/whl/cu121 \
    -r requirements.txt

# Copy application code
COPY --chown=1001:0 src/ ./src/

ENV PYTHONUNBUFFERED=1
ENV MODEL_PATH=/mnt/models
ENV HF_HOME=/tmp/hf_home

EXPOSE 8080

CMD ["python", "-m", "uvicorn", "src.server:app", "--host", "0.0.0.0", "--port", "8080"]
